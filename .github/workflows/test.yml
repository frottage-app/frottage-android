name: Test
on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: write
  contents: read

env:
  GITHUB_ACTIONS: true # For tools that might adjust output for GHA
  FORCE_COLOR: 1
  GRADLE_OPTS: -Dorg.gradle.daemon=false # Ensure Gradle daemon is not used

jobs:
  test:
    name: Test
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Nix Cache
      uses: DeterminateSystems/magic-nix-cache-action@main

    - name: Install devbox
      uses: jetify-com/devbox-install-action@v0.13.0

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Lint code
      run: |
        devbox run -- just lint

    - name: Build project
      run: |
        devbox run -- ./gradlew assembleDebug
